<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Configuration - API Key Management Service</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --accent: #f093fb;
            --dark: #1a1a2e;
            --light: #f8f9fa;
            --code-bg: #282c34;
            --border: #e0e0e0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .nav {
            background: var(--dark);
            padding: 15px 40px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .nav a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .nav a:hover {
            background: var(--primary);
            transform: translateY(-2px);
        }

        .content {
            padding: 40px;
        }

        h1, h2, h3, h4, h5, h6 {
            color: var(--dark);
            margin: 30px 0 15px 0;
            line-height: 1.3;
        }

        h1 { font-size: 2.5em; border-bottom: 3px solid var(--primary); padding-bottom: 10px; }
        h2 { font-size: 2em; border-bottom: 2px solid var(--border); padding-bottom: 8px; margin-top: 40px; }
        h3 { font-size: 1.5em; color: var(--primary); }
        h4 { font-size: 1.3em; }

        p {
            margin: 15px 0;
            line-height: 1.8;
        }

        a {
            color: var(--primary);
            text-decoration: none;
            border-bottom: 1px dotted var(--primary);
        }

        a:hover {
            color: var(--secondary);
            border-bottom: 1px solid var(--secondary);
        }

        code {
            background: #f4f4f4;
            padding: 3px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #e83e8c;
        }

        pre {
            background: var(--code-bg);
            color: #abb2bf;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 20px 0;
            border-left: 4px solid var(--primary);
        }

        pre code {
            background: none;
            color: inherit;
            padding: 0;
            font-size: 0.95em;
        }

        blockquote {
            border-left: 4px solid var(--primary);
            padding: 15px 20px;
            margin: 20px 0;
            background: #f8f9fa;
            font-style: italic;
        }

        ul, ol {
            margin: 15px 0;
            padding-left: 30px;
        }

        li {
            margin: 8px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .footer {
            background: var(--dark);
            color: white;
            padding: 30px 40px;
            text-align: center;
        }

        .footer a {
            color: var(--accent);
            border-bottom: 1px dotted var(--accent);
        }

        .back-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--primary);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            text-decoration: none;
            font-size: 24px;
        }

        .back-to-top:hover {
            background: var(--secondary);
            transform: translateY(-5px);
        }

        @media (max-width: 768px) {
            .container {
                border-radius: 0;
            }

            .header {
                padding: 30px 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .nav {
                padding: 15px 20px;
            }

            .content {
                padding: 20px;
            }

            pre {
                padding: 15px;
                font-size: 0.85em;
            }
        }

        /* Syntax highlighting for code blocks */
        .codehilite .k { color: #c678dd; } /* keyword */
        .codehilite .s { color: #98c379; } /* string */
        .codehilite .n { color: #e06c75; } /* name */
        .codehilite .c { color: #5c6370; font-style: italic; } /* comment */
        .codehilite .m { color: #d19a66; } /* number */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Dynamic Configuration</h1>
            <p>API Key Management Service</p>
        </div>

        <div class="nav">
            <a href="/">üè† Home</a>
            <a href="/quickstart">üöÄ Quick Start</a>
            <a href="/public/guides/admnistration.html">üîê Administration</a>
            <a href="/docs">üìö API Docs</a>
            <a href="/redoc">üìñ ReDoc</a>
        </div>

        <div class="content">
<h1 id="dynamic-project-configuration">Dynamic Project Configuration</h1>
<h2 id="overview">Overview</h2>
<p>The AKM system supports <strong>dynamic runtime configuration</strong> per project, allowing clients to update settings without code deployment or service restart. This enables self-service management of CORS, rate limits, IP restrictions, and other operational parameters.</p>
<h2 id="architecture">Architecture</h2>
<h3 id="configuration-layers">Configuration Layers</h3>
<div class="codehilite"><pre><span></span><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   Configuration Priority                    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 1. API Key Level      (Most Specific)                      ‚îÇ
‚îÇ    ‚îî‚îÄ Individual key overrides                             ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ 2. Project Configuration (Database)                        ‚îÇ
‚îÇ    ‚îî‚îÄ Runtime-configurable settings                        ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ 3. Global Defaults (Environment Variables)                 ‚îÇ
‚îÇ    ‚îî‚îÄ Fallback values                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div>

<h2 id="supported-configurations">Supported Configurations</h2>
<h3 id="1-cors-origins">1. CORS Origins</h3>
<p><strong>Purpose</strong>: Control which domains can make requests to APIs protected by project keys.</p>
<p><strong>Storage</strong>: <code>akm_project_configurations.cors_origins</code> (JSON array)</p>
<p><strong>Example</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;cors_origins&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;https://app.example.com&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;https://staging.example.com&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;http://localhost:3000&quot;</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Application</strong>: 
- When a request is made with an API key, the system checks if the <code>Origin</code> header matches any configured origin
- If no project CORS is configured, falls back to global <code>CORS_ORIGINS</code> from env</p>
<h3 id="2-rate-limits">2. Rate Limits</h3>
<p><strong>Purpose</strong>: Set default rate limits for all keys in a project.</p>
<p><strong>Storage</strong>: Multiple columns in <code>akm_project_configurations</code>
- <code>default_rate_limit_per_minute</code>
- <code>default_rate_limit_per_hour</code>
- <code>default_rate_limit_per_day</code>
- <code>default_rate_limit_per_month</code></p>
<p><strong>Priority</strong>:
1. Individual key's rate limit (if set)
2. Project's default rate limit (if set)
3. Global default (from code)</p>
<p><strong>Example</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;default_rate_limit_per_hour&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10000</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;default_rate_limit_per_day&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">200000</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="3-ip-allowlist">3. IP Allowlist</h3>
<p><strong>Purpose</strong>: Restrict API key usage to specific IP addresses or CIDR ranges.</p>
<p><strong>Storage</strong>: <code>akm_project_configurations.ip_allowlist</code> (JSON array)</p>
<p><strong>Example</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;ip_allowlist&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;203.0.113.0/24&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;198.51.100.42&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;192.0.2.0/25&quot;</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Validation</strong>:
- CIDR notation is validated on input
- Requests from non-allowlisted IPs are rejected with 403</p>
<h3 id="4-webhook-settings">4. Webhook Settings</h3>
<p><strong>Purpose</strong>: Configure webhook behavior per project.</p>
<p><strong>Storage</strong>:
- <code>webhook_timeout_seconds</code> (default: 30)
- <code>webhook_max_retries</code> (default: 3)</p>
<p><strong>Example</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;webhook_timeout_seconds&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">60</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;webhook_max_retries&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="5-custom-sensitive-fields">5. Custom Sensitive Fields</h3>
<p><strong>Purpose</strong>: Define project-specific fields that should be sanitized in logs.</p>
<p><strong>Storage</strong>: <code>akm_project_configurations.custom_sensitive_fields</code> (JSON array)</p>
<p><strong>Example</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;custom_sensitive_fields&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;customer_ssn&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;credit_card&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;internal_id&quot;</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Integration</strong>: Merged with global sensitive fields during sanitization.</p>
<h2 id="api-endpoints">API Endpoints</h2>
<h3 id="createupdate-project-configuration">Create/Update Project Configuration</h3>
<div class="codehilite"><pre><span></span><code><span class="err">PUT /akm/v1/projects/{project_id}/configuration</span>
<span class="err">Content-Type: application/json</span>
<span class="err">X-API-Key: akm_live_admin_key</span>

<span class="err">{</span>
<span class="err">  &quot;cors_origins&quot;: [&quot;https://app.example.com&quot;],</span>
<span class="err">  &quot;default_rate_limit_per_hour&quot;: 5000,</span>
<span class="err">  &quot;ip_allowlist&quot;: [&quot;203.0.113.0/24&quot;],</span>
<span class="err">  &quot;webhook_timeout_seconds&quot;: 45,</span>
<span class="err">  &quot;custom_sensitive_fields&quot;: [&quot;user_token&quot;]</span>
<span class="err">}</span>
</code></pre></div>

<h3 id="get-project-configuration">Get Project Configuration</h3>
<div class="codehilite"><pre><span></span><code><span class="err">GET /akm/v1/projects/{project_id}/configuration</span>
<span class="err">X-API-Key: akm_live_admin_key</span>
</code></pre></div>

<h3 id="delete-configuration-reset-to-defaults">Delete Configuration (Reset to Defaults)</h3>
<div class="codehilite"><pre><span></span><code><span class="err">DELETE /akm/v1/projects/{project_id}/configuration</span>
<span class="err">X-API-Key: akm_live_admin_key</span>
</code></pre></div>

<h2 id="configuration-application">Configuration Application</h2>
<h3 id="how-changes-are-applied">How Changes Are Applied</h3>
<ol>
<li><strong>No Restart Required</strong>: Changes take effect immediately</li>
<li><strong>Database-Driven</strong>: Configuration is read from DB on each request</li>
<li><strong>Caching</strong>: Configurations are cached per request (not across requests)</li>
<li><strong>Fallback</strong>: Missing configurations use global defaults</li>
</ol>
<h3 id="example-flow-cors-check">Example Flow: CORS Check</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Pseudo-code</span>
<span class="k">def</span> <span class="nf">check_cors</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">api_key</span><span class="p">):</span>
    <span class="c1"># 1. Get project from API key</span>
    <span class="n">project_id</span> <span class="o">=</span> <span class="n">api_key</span><span class="o">.</span><span class="n">project_id</span>

    <span class="c1"># 2. Load project configuration</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">get_project_configuration</span><span class="p">(</span><span class="n">project_id</span><span class="p">)</span>

    <span class="c1"># 3. Check CORS</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">cors_origins</span><span class="p">:</span>
        <span class="n">allowed</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">cors_origins</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">allowed</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">cors_origins_list</span>  <span class="c1"># Global fallback</span>

    <span class="c1"># 4. Validate origin</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Origin&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="s2">&quot;CORS origin not allowed&quot;</span><span class="p">)</span>
</code></pre></div>

<h2 id="use-cases">Use Cases</h2>
<h3 id="1-multi-environment-development">1. Multi-Environment Development</h3>
<p><strong>Scenario</strong>: Client has dev, staging, and production environments.</p>
<p><strong>Solution</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;cors_origins&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;http://localhost:3000&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;https://dev.example.com&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;https://staging.example.com&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;https://example.com&quot;</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="2-gradual-rate-limit-increase">2. Gradual Rate Limit Increase</h3>
<p><strong>Scenario</strong>: Client starts with low limits, needs to scale up.</p>
<p><strong>Solution</strong>: Update configuration without code changes</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;default_rate_limit_per_hour&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">50000</span><span class="w">  </span><span class="c1">// Increased from 10000</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="3-security-incident-response">3. Security Incident Response</h3>
<p><strong>Scenario</strong>: Suspicious activity detected from specific IPs.</p>
<p><strong>Solution</strong>: Temporarily restrict to known IPs</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;ip_allowlist&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;198.51.100.0/24&quot;</span><span class="p">]</span><span class="w">  </span><span class="c1">// Only corporate network</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="4-compliance-requirements">4. Compliance Requirements</h3>
<p><strong>Scenario</strong>: Client operates in regulated industry, needs custom field sanitization.</p>
<p><strong>Solution</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;custom_sensitive_fields&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;patient_id&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;medical_record_number&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;ssn&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;tax_id&quot;</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="implementation-details">Implementation Details</h2>
<h3 id="database-schema">Database Schema</h3>
<div class="codehilite"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">akm_project_configurations</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">SERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">project_id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">akm_projects</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
<span class="w">    </span><span class="n">cors_origins</span><span class="w"> </span><span class="n">JSONB</span><span class="p">,</span>
<span class="w">    </span><span class="n">default_rate_limit_per_minute</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">    </span><span class="n">default_rate_limit_per_hour</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">    </span><span class="n">default_rate_limit_per_day</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">    </span><span class="n">default_rate_limit_per_month</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">    </span><span class="n">ip_allowlist</span><span class="w"> </span><span class="n">JSONB</span><span class="p">,</span>
<span class="w">    </span><span class="n">webhook_timeout_seconds</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span>
<span class="w">    </span><span class="n">webhook_max_retries</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
<span class="w">    </span><span class="n">custom_sensitive_fields</span><span class="w"> </span><span class="n">JSONB</span><span class="p">,</span>
<span class="w">    </span><span class="n">config_metadata</span><span class="w"> </span><span class="n">JSONB</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="n">updated_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_project_config_project</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">akm_project_configurations</span><span class="p">(</span><span class="n">project_id</span><span class="p">);</span>
</code></pre></div>

<h3 id="repository-pattern">Repository Pattern</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">ProjectConfigurationRepository</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_by_project_id</span><span class="p">(</span><span class="n">project_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AKMProjectConfiguration</span><span class="p">]</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">upsert</span><span class="p">(</span><span class="n">project_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AKMProjectConfiguration</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">project_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span>
</code></pre></div>

<h3 id="validation-rules">Validation Rules</h3>
<ol>
<li><strong>CORS Origins</strong>: Must be valid URLs or wildcard patterns</li>
<li><strong>Rate Limits</strong>: Must be positive integers</li>
<li><strong>IP Allowlist</strong>: Must be valid IPv4/IPv6 addresses or CIDR notation</li>
<li><strong>Webhook Timeouts</strong>: 1-300 seconds</li>
<li><strong>Webhook Retries</strong>: 0-10 attempts</li>
</ol>
<h2 id="security-considerations">Security Considerations</h2>
<h3 id="access-control">Access Control</h3>
<ul>
<li>Configuration management requires <strong>project admin scope</strong>: <code>akm:projects:write</code></li>
<li>Read access requires: <code>akm:projects:read</code></li>
<li>Configuration changes are <strong>audited</strong> in audit logs</li>
</ul>
<h3 id="cors-security">CORS Security</h3>
<ul>
<li>Wildcard (<code>*</code>) is <strong>not allowed</strong> for security</li>
<li>Each origin must be explicitly listed</li>
<li>Origins are validated on configuration update</li>
</ul>
<h3 id="ip-allowlist-security">IP Allowlist Security</h3>
<ul>
<li>Empty allowlist means <strong>no restrictions</strong> (all IPs allowed)</li>
<li>Non-empty allowlist is <strong>enforced strictly</strong></li>
<li>Invalid CIDR ranges are rejected</li>
</ul>
<h2 id="migration-guide">Migration Guide</h2>
<h3 id="updating-client-applications">Updating Client Applications</h3>
<p><strong>Before (Hardcoded)</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">API_URL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;https://akm.example.com&quot;</span><span class="p">;</span>
<span class="c1">// Client is blocked by CORS</span>
</code></pre></div>

<p><strong>After (Dynamic CORS)</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Admin updates configuration</span>
curl<span class="w"> </span>-X<span class="w"> </span>PUT<span class="w"> </span>https://akm.example.com/akm/v1/projects/1/configuration<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;X-API-Key: admin_key&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-d<span class="w"> </span><span class="s1">&#39;{</span>
<span class="s1">    &quot;cors_origins&quot;: [&quot;https://client-app.com&quot;]</span>
<span class="s1">  }&#39;</span>

<span class="c1"># Client app now works immediately (no restart needed)</span>
</code></pre></div>

<h2 id="best-practices">Best Practices</h2>
<h3 id="1-start-restrictive">1. Start Restrictive</h3>
<p>Begin with minimal CORS origins and rate limits, expand as needed:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;cors_origins&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;https://production-only.com&quot;</span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;default_rate_limit_per_hour&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="2-use-cidr-ranges-for-ips">2. Use CIDR Ranges for IPs</h3>
<p>Instead of individual IPs:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;ip_allowlist&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;203.0.113.0/24&quot;</span><span class="p">]</span><span class="w">  </span><span class="c1">// Entire subnet</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="3-document-changes">3. Document Changes</h3>
<p>Use <code>config_metadata</code> for change tracking:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;config_metadata&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;updated_by&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;admin@example.com&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;change_reason&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Added staging environment&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;ticket&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;OPS-1234&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="4-test-before-production">4. Test Before Production</h3>
<p>Update staging project configuration first:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Test on staging</span>
PUT<span class="w"> </span>/akm/v1/projects/staging-project/configuration

<span class="c1"># After validation, apply to production</span>
PUT<span class="w"> </span>/akm/v1/projects/prod-project/configuration
</code></pre></div>

<h2 id="monitoring">Monitoring</h2>
<h3 id="configuration-change-alerts">Configuration Change Alerts</h3>
<p>Set up alerts for configuration changes:
- CORS origins added/removed
- Rate limits significantly changed
- IP allowlist modified</p>
<h3 id="audit-trail">Audit Trail</h3>
<p>All configuration changes are logged:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;event_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;PROJECT_CONFIGURATION_UPDATED&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;project_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">123</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;changes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;cors_origins&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;https://new-domain.com&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;updated_by_key_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">456</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;timestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2025-11-23T22:00:00Z&quot;</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="troubleshooting">Troubleshooting</h2>
<h3 id="cors-errors">CORS Errors</h3>
<p><strong>Symptom</strong>: <code>Access-Control-Allow-Origin</code> errors in browser</p>
<p><strong>Solution</strong>:
1. Check project configuration has correct origin
2. Ensure origin matches exactly (including protocol and port)
3. Verify API key belongs to correct project</p>
<h3 id="rate-limit-exceeded">Rate Limit Exceeded</h3>
<p><strong>Symptom</strong>: 429 Too Many Requests</p>
<p><strong>Solution</strong>:
1. Check current limits: <code>GET /akm/v1/projects/{id}/configuration</code>
2. Increase if justified: <code>PUT /akm/v1/projects/{id}/configuration</code>
3. Monitor usage to prevent abuse</p>
<h3 id="ip-blocked">IP Blocked</h3>
<p><strong>Symptom</strong>: 403 Forbidden with "IP not allowed"</p>
<p><strong>Solution</strong>:
1. Verify client IP address
2. Check allowlist includes IP/CIDR
3. Temporarily remove allowlist for testing</p>
<h2 id="future-enhancements">Future Enhancements</h2>
<ul>
<li><strong>Time-based rate limits</strong>: Burst limits vs sustained</li>
<li><strong>Geographic restrictions</strong>: Allow/block by country</li>
<li><strong>Custom headers</strong>: Project-specific required headers</li>
<li><strong>Automatic CORS detection</strong>: Learn origins from usage patterns</li>
<li><strong>Configuration versioning</strong>: Rollback to previous configurations</li>
<li><strong>A/B testing</strong>: Split traffic with different rate limits</li>
</ul>
<hr />
<p><strong>Related Documentation</strong>:
- <a href="ARCHITECTURE_ISSUES_AND_IMPROVEMENTS.md">Multi-Tenant Architecture</a>
- <a href="AKM_SYSTEM.md#rate-limiting">Rate Limiting</a>
- <a href="AUDIT_SYSTEM.md">Audit Logging</a>
- <a href="SENSITIVE_FIELDS.md">Sensitive Fields</a></p>
        </div>

        <div class="footer">
            <p>Built with ‚ù§Ô∏è using FastAPI, PostgreSQL, and SQLAlchemy</p>
            <p style="margin-top: 10px;">¬© 2025 API Key Management Service by <a href="https://github.com/ideiasfactory" target="_blank">Ideias Factory</a></p>
        </div>
    </div>

    <a href="#" class="back-to-top">‚Üë</a>

    <script>
        // Smooth scroll for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        });

        // Back to top button
        const backToTop = document.querySelector('.back-to-top');
        window.addEventListener('scroll', () => {
            if (window.pageYOffset > 300) {
                backToTop.style.display = 'flex';
            } else {
                backToTop.style.display = 'none';
            }
        });

        backToTop.addEventListener('click', (e) => {
            e.preventDefault();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    </script>
</body>
</html>